{# templates/messaging/new_broadcast.html #}
{% extends 'messaging/base_messaging.html' %}
{% load static %}

{% block messaging_extra_head %}
<style>
    .recipient-counter {
        display: inline-block;
        padding: 5px 10px;
        background-color: #f0f0f0;
        border-radius: 20px;
        margin-left: 10px;
        font-size: 0.9rem;
    }
    
    .recipient-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }
    
    .recipient-item {
        display: inline-block;
        padding: 3px 8px;
        background-color: #e9f5ff;
        border-radius: 15px;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .broadcast-help-text {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .broadcast-help-text h5 {
        margin-top: 0;
    }
    
    .broadcast-help-text ul {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block messaging_content %}
<div class="container py-4">
    <h3 class="mb-4">Send Broadcast Message</h3>
    
    <div class="broadcast-help-text">
        <h5><i class="fas fa-info-circle"></i> About Broadcast Messages</h5>
        <p>Broadcast messages are sent to multiple recipients at once. Each recipient receives the message in a separate conversation with you.</p>
        <ul>
            <li>Recipients cannot see who else received the message</li>
            <li>Replies will come as private messages to you only</li>
            <li>Use broadcasts for announcements or important information</li>
        </ul>
    </div>
    
    <form method="post" class="broadcast-form">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            {{ form.name }}
            {% if form.name.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.name.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            <div class="form-text">
                Give your broadcast a title (optional).
            </div>
        </div>
        
        <div class="mb-3">
            <label for="{{ form.recipients.id_for_label }}" class="form-label">
                {{ form.recipients.label }}
                <span class="recipient-counter" id="recipient-counter">0 selected</span>
            </label>
            {{ form.recipients }}
            {% if form.recipients.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.recipients.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            <div class="form-text">
                Select the users who will receive this broadcast message.
            </div>
            
            <div class="recipient-list" id="recipient-list"></div>
        </div>
        
        <div class="mb-4">
            <label for="{{ form.message.id_for_label }}" class="form-label">{{ form.message.label }}</label>
            {{ form.message }}
            {% if form.message.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.message.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div class="text-end">
            <a href="{% url 'messaging:inbox' %}" class="btn btn-secondary me-2">Cancel</a>
            <button type="submit" class="btn btn-primary">Send Broadcast</button>
        </div>
    </form>
</div>
{% endblock %}

{% block messaging_extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize select2 for better recipient selection
        const recipientsSelect = $('#{{ form.recipients.id_for_label }}');
        recipientsSelect.select2({
            theme: 'bootstrap4',
            placeholder: 'Search for users...',
            width: '100%',
            closeOnSelect: false
        });
        
        // Update recipient count and list
        function updateRecipients() {
            const selectedRecipients = recipientsSelect.select2('data');
            const count = selectedRecipients.length;
            
            // Update counter
            document.getElementById('recipient-counter').textContent = `${count} selected`;
            
            // Update recipient list
            const recipientList = document.getElementById('recipient-list');
            recipientList.innerHTML = '';
            
            selectedRecipients.forEach(recipient => {
                const recipientItem = document.createElement('span');
                recipientItem.className = 'recipient-item';
                recipientItem.textContent = recipient.text;
                recipientList.appendChild(recipientItem);
            });
        }
        
        // Initial update
        updateRecipients();
        
        // Update when selection changes
        recipientsSelect.on('change', updateRecipients);
        
        // Confirm before sending to many recipients
        document.querySelector('.broadcast-form').addEventListener('submit', function(e) {
            const count = recipientsSelect.select2('data').length;
            
            if (count > 20) {
                if (!confirm(`You are about to send this broadcast to ${count} recipients. Are you sure?`)) {
                    e.preventDefault();
                }
            }
        });
    });
</script>
{% endblock %}